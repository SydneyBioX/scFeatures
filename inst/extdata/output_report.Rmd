---
title: "Association study of features with conditions"
output:
  html_document:
    code_folding: hide
    fig_height: 6
    fig_width: 8
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r, include = FALSE}

.libPaths("/albona/nobackup/yuec/scfeatures/scfeatures_package/dependency")

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r warning=FALSE, message=FALSE}
library(ggplot2)
library(reshape2)
library(dplyr)
library(pheatmap)
library(limma)
library(DT)
library(tidyr)    
library(igraph)
library(grid)


organism = "org.Hs.eg.db"
library(organism, character.only = TRUE)

library(EnsDb.Hsapiens.v79)
library(msigdbr)


library(clusterProfiler)
library(DOSE)
library(enrichplot)
 
 
 
```


```{r }
scfeatures_result <- readRDS( system.file("extdata", "scfeatures_result.rds",  
                            package = "scFeatures"))
```
 

```{r}
# helper function to plot barplot distribution
plot_barplot <- function(data , dodge=F){
  

  data$patient <- unlist( lapply( strsplit( rownames(data ), "_cond_"), `[`, 1))
  data$condition <- unlist( lapply( strsplit( rownames(data ), "_cond_"), `[`, 2))
  
  data <- as.data.frame( melt(data, id=c("patient", "condition")) )
 
  if(dodge){
    print( ggplot(data , aes( x = patient , y = value , fill = variable) ) +   
    geom_bar(stat="identity"  ) + facet_wrap(~variable+condition, scale="free") + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) ) 
  } else{
    print( ggplot(data , aes( x = patient , y = value , fill = variable) ) +   
    geom_bar(stat="identity"   ) + facet_wrap(~condition, scale="free") + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) )
  }
 
}

plot_boxplot <- function(data){
  
   data <- t(data)
   patient <- unlist( lapply( strsplit( colnames(data), "_cond_"), `[`, 1) ) 
    
    remove <- which(patient == "NA")
    if (length(remove) > 0 ){
       patient <-  patient[-c(remove)]
       data <- data[ ,  -c(remove)]
    }
    condition  <- unlist( lapply( strsplit( colnames(data), "_cond_"), `[`, 2))
    condition <- data.frame(condition = condition )
    
 
    design <- model.matrix(~condition, data = condition)
    fit <- lmFit(data, design)
    fit <- eBayes(fit)
     
    tT <- topTable(fit, n = Inf) 

    data <- melt(data)
    
  
    print(paste0( "up regulated in ", unique(condition$condition)[1]))
    top_gene <- tT[ tT$logFC > 0 , ]
    top_gene <- rownames(top_gene )
 
   if (length(top_gene ) == 0){
          
   }else {
      data_toplot <- data[data$Var1 %in%  top_gene, ]
      data_toplot$cond <-  unlist( lapply( strsplit(as.character(data_toplot$Var2), "_cond_"), `[`, 2))
      data_toplot$Var1 <- factor(data_toplot$Var1, levels =top_gene )
      
      print ( ggplot( data_toplot, aes( y = value, x = Var1 , colour = cond)) + geom_boxplot() +   geom_point(aes(fill = cond), size = 2, shape = 21, position = position_jitterdodge()) + theme_minimal()  )  
    }
    print(paste0( "down regulated in ", unique(condition$condition)[1]))
    top_gene <- tT[ tT$logFC < 0 , ]
    top_gene <- rownames(top_gene ) 
 
    
    if (length(top_gene ) == 0){
          
    }else{
      
      data_toplot <- data[data$Var1 %in%  top_gene, ]
      data_toplot$cond <-  unlist( lapply( strsplit(as.character(data_toplot$Var2), "_cond_"), `[`, 2))
      data_toplot$Var1 <- factor(data_toplot$Var1, levels =top_gene )
    
       print ( ggplot( data_toplot, aes( y = value, x = Var1 , colour = cond)) + geom_boxplot() +   geom_point(aes(fill = cond), size = 2, shape = 21, position = position_jitterdodge()) + theme_minimal()  )  
      
    }
 
  
  
}

```
 
 
```{r eval=TRUE, include=FALSE}
 
cond <- rownames( scfeatures_result[[1]]) 
cond <- unlist(lapply(strsplit(cond, "_cond_"), `[` , 2))
cond1 <- unique(cond)[1]
cond2 <- unique(cond)[2]
 
```
 


# Overview

This html runs association study of the features generated by scFeatures with phenotypic outcomes such as disease conditions and output a series of plots to visualise the association study result. 



# Cell type proportions

## Proportion raw

The barplot shows cell type composition of the data, split by condition. 

```{r fig.height=4, fig.width=8}
if("feature_proportion_raw" %in% names(scfeatures_result) ){
    data <- scfeatures_result$feature_proportion_raw
    plot_barplot(data)
}
```

The two boxplots show the up-regulated cell type in `r cond1` compared to the `r cond2` and the down-regulated cell type, respectively. Each dot on the boxplot represent the cell type proportion of an individual for that particular cell type. 

```{r  fig.height=4, fig.width=8 }
if("feature_proportion_raw" %in% names(scfeatures_result) ){
    data <- scfeatures_result$feature_proportion_raw
    plot_boxplot(data)
}
```


## Proportion logit

The barplot shows cell type composition with logit transformation, split by condition. 

The two boxplots show the up-regulated cell type in `r cond1` compared to the `r cond2` and the down-regulated cell type, respectively. Each dot on the boxplot represent the cell type proportion (after logit transformation) of an individual for that particular cell type. 


```{r fig.height=6, fig.width=10}
if("feature_proportion_logit" %in% names(scfeatures_result) ){
    data <- scfeatures_result$feature_proportion_logit
    plot_barplot(data, dodge = T)
}
```


```{r  fig.height=4, fig.width=8 }
if("feature_proportion_logit" %in% names(scfeatures_result) ){
    data <- scfeatures_result$feature_proportion_logit
    plot_boxplot(data)
}
```


## Pairwise ratio of proportion

The barplot shows pairwise ratio of cell type proportion (ie, proportion of cell type 1 / proportion of cell type 2), split by condition. 

The two boxplots show the up-regulated ratio of proportion in `r cond1` compared to the `r cond2` and the down-regulated ratio of proportion, respectively. Each dot on the boxplot represent the proportion ratio of an individual for that particular cell type. 


```{r fig.height=6, fig.width=12}
if("feature_proportion_ratio" %in% names(scfeatures_result) ){
  data <- scfeatures_result$feature_proportion_ratio
  plot_barplot(data, dodge = T)
}
```


```{r  fig.height=4, fig.width=8 }
if("feature_proportion_ratio" %in% names(scfeatures_result) ){
    data <- scfeatures_result$feature_proportion_ratio
    plot_boxplot(data)
}
```


# Cell type specific gene expressions 


```{r}

# helper function to plot heatmap 

plot_heatmap <- function(data, num_features = 50, pathway = F ){
  
    
    patient <- unlist( lapply( strsplit( colnames(data), "_cond_"), `[`, 1) ) 
    
    remove <- which(patient == "NA")
    if (length(remove) > 0 ){
       patient <-  patient[-c(remove)]
       data <- data[ , -c(remove)]
    }
        
    condition  <- unlist( lapply( strsplit( colnames(data), "_cond_"), `[`, 2))
    condition <- data.frame(condition = condition )
    
    if (pathway){
      celltype <- unlist( lapply( strsplit(rownames(data), "--"), `[`, 2) )
    }else{
       celltype <- unlist( lapply( strsplit(rownames(data), "--"), `[`, 1) )
    }
   
    gene_output <- list()
    # thiscelltype  <- unique(celltype)[1]
    for ( thiscelltype in unique(celltype)){

        label <- thiscelltype 
        print(paste0( "==========", label,  "=========="))
        thiscelltype <- data[ which(celltype == thiscelltype), ]
    
        design <- model.matrix(~condition, data = condition)
        fit <- lmFit(thiscelltype, design)
        fit <- eBayes(fit)
     
        suppressMessages ( tT <- topTable(fit, n = Inf)  )
        gene_output[[label]] <- tT
        
       # print(DT::datatable(round(tT, 2)))
          
        print(paste0( "up regulated in ", unique(condition$condition)[1]))
        top_gene <- tT[ tT$logFC > 0 , ]
        top_gene <- rownames(top_gene )[1:min( num_features, nrow(top_gene)) ]
        rownames(  condition) <- colnames(thiscelltype)
        
        if (length(top_gene) == 0){
          
        }else if (length(top_gene) == 1){
           pheatmap( thiscelltype[top_gene, , drop=FALSE]  ,   
                  annotation = condition,
                 main = label , cluster_rows = F )
        }else{
            pheatmap( thiscelltype[top_gene,  , drop=FALSE]  , 
                   annotation = condition,
                 main = label , fontsize_row = 5 , fontsize_col = 5,
                 scale = "row")
        }
      
        
        
        print(paste0( "down regulated in ", unique(condition$condition)[1]))
        top_gene <- tT[ tT$logFC < 0 , ]
        top_gene <- rownames(top_gene )[1:min( num_features, nrow(top_gene)) ]
        rownames(  condition) <- colnames(thiscelltype)
        
        if (length(top_gene ) == 0){
          
        }else if (length(top_gene) == 1){
             pheatmap( thiscelltype[top_gene, , drop=FALSE]  ,   
                  annotation = condition,
                 main = label , cluster_rows = F )
        }else{
            pheatmap( thiscelltype[top_gene, ]  ,  annotation = condition,
                 main = label , fontsize_row = 5 , fontsize_col = 5,
                 scale = "row")
        }
      
     
    } 

    return(gene_output)
} 


plot_heatmap_bulk <- function(data , num_features = 50 ){
   
   
     
    patient <- unlist( lapply( strsplit( colnames(data), "_cond_"), `[`, 1) ) 
    remove <- which(patient == "NA")
    if (length(remove) > 0 ){
       patient <-  patient[-c(remove)]
       data <- data[ ,  -c(remove)]
    }
    condition  <- unlist( lapply( strsplit( colnames(data), "_cond_"), `[`, 2))
    condition <- data.frame(condition = condition )
    
 
    design <- model.matrix(~condition, data = condition)
    fit <- lmFit(data, design)
    fit <- eBayes(fit)
     
   suppressMessages ( tT <- topTable(fit, n = Inf) )
    gene_output <- tT
        
    # print ( DT::datatable(round(tT, 2)) )
          
    print(paste0( "up regulated in ", unique(condition$condition)[1]))
    top_gene <- tT[ tT$logFC > 0 , ]
    top_gene <- rownames(top_gene )[1:min( num_features, nrow(top_gene)) ]
    rownames( condition) <- colnames(data)
    
   if (length(top_gene ) == 0){
          
    }else if (length(top_gene) == 1){
             pheatmap( thiscelltype[top_gene, , drop=FALSE]  ,   
                  annotation = condition,
                 main = label , cluster_rows = F )
   }else{
          pheatmap( data[top_gene, ]  ,  annotation = condition,
              fontsize_row = 5 , fontsize_col = 5,
                scale = "row")
   }
    
        
        
    print(paste0( "down regulated in ", unique(condition$condition)[1]))
    top_gene <- tT[ tT$logFC < 0 , ]
    top_gene <- rownames(top_gene )[1:min( num_features, nrow(top_gene)) ]
    rownames(  condition) <- colnames(data)
    
    if (length(top_gene ) == 0){
          
    }else if (length(top_gene) == 1){
             pheatmap( thiscelltype[top_gene, , drop=FALSE]  ,   
                  annotation = condition,
                 main = label , cluster_rows = F )
   }else{
     
    pheatmap( data[top_gene, ]  ,  annotation = condition,
               fontsize_row = 5 , fontsize_col = 5,
                 scale = "row")
   }
 

    return(gene_output)
  
}
```




```{r}
# helper function to plot pathway enrichment of top genes 

plot_go <- function(gene_output){
 
 #  thiscelltype <- names(gene_output)[1]
  for (thiscelltype in names(gene_output)){
      gene <- gene_output[[thiscelltype]]
      print(paste0( "==========", thiscelltype,  "=========="))
    
      try({
        print("up regulated")
        
        up <- rownames(gene[gene$logFC > 0, ])[1:200]
        up <- unlist(lapply( strsplit(up , "--"), `[`, 2))
       
        gse <- enrichGO(gene = up , 
                   ont ="BP" ,  keyType = "SYMBOL" , 
                   minGSSize = 3,   maxGSSize = 800, 
                   pvalueCutoff =0.05,  pAdjustMethod =  "fdr",
                   OrgDb = organism  )
        
        print ( dotplot(gse, showCategory=10  , font.size = 8) ) 
      }) 
      
      try({
        print("down regulated")
        down <- rownames(gene[gene$logFC < 0, ])[1:200]
        down <- unlist(lapply( strsplit(down , "--"), `[`, 2))
       
        gse <- enrichGO(gene = down , 
                   ont ="BP" ,  keyType = "SYMBOL" , 
                   minGSSize = 3,   maxGSSize = 800, 
                   pvalueCutoff =0.05,  pAdjustMethod =  "fdr",
                   OrgDb = organism  )
        
        print ( dotplot(gse, showCategory=10  ,  font.size = 8) ) 
      }) 
  
  }

}

plot_go_bulk  <- function(gene_output){
 
 
      try({
        print("up regulated")
        
        up <- rownames(gene_output[gene_output$logFC > 0, ])[1:200]

        gse <- enrichGO(gene = up , 
                   ont ="BP" ,  keyType = "SYMBOL" , 
                   minGSSize = 3,   maxGSSize = 800, 
                   pvalueCutoff =0.05,  pAdjustMethod =  "fdr",
                   OrgDb = organism  )
        
        print ( dotplot(gse, showCategory=10,  font.size = 8 ) ) 
      }) 
      
      try({
        print("down regulated")
        down <- rownames(gene_output[gene_output$logFC < 0, ])[1:200]
        
        gse <- enrichGO(gene = down , 
                   ont ="BP" ,  keyType = "SYMBOL" , 
                   minGSSize = 3,   maxGSSize = 800, 
                   pvalueCutoff =0.05,  pAdjustMethod =  "fdr",
                   OrgDb = organism  )
        
        print ( dotplot(gse, showCategory=10, font.size = 8 ) ) 
      }) 
  
 

}


```



## gene mean celltype 

The heatmaps show the up-regulated gene in `r cond1` compared to the `r cond2` and the down-regulated gene, respectively, for each cell type. Value represents average gene expression. The top 50 genes are shown for readability. 

The enrichment plots show enrichment in biological pathways of the top 200 up-regulated or down-regulated genes in each cell type. Top 10 pathways are shown. 

```{r}
if("feature_gene_mean_celltype" %in% names(scfeatures_result) ){
    data <- scfeatures_result$feature_gene_mean_celltype
    data <- t(data)
    
    gene_output <- plot_heatmap(data)
}
```

```{r fig.height=4, fig.width=6}
if("feature_gene_mean_celltype" %in% names(scfeatures_result) ){
    plot_go(gene_output)
}
```



## gene proportion celltype


The heatmaps show the up-regulated gene in `r cond1` compared to the `r cond2` and the down-regulated gene, respectively, for each cell type. Value represents average proportion of expression (ie, across all cells, the percentage of cells that express a particular gene). The top 50 genes are shown for readability. 

The enrichment plots show enrichment in biological pathways of the top 200 up-regulated or down-regulated genes in each cell type. Top 10 pathways are shown. 



```{r}
if("feature_gene_prop_celltype" %in% names(scfeatures_result) ){
    data <- scfeatures_result$feature_gene_prop_celltype
    data <- t(data)
    
    gene_output <- plot_heatmap(data)
}
```

```{r fig.height=4, fig.width=6}
if("feature_gene_prop_celltype" %in% names(scfeatures_result) ){
    plot_go(gene_output)
}
```


## gene correlation celltype

The heatmaps show the up-regulated gene in `r cond1` compared to the `r cond2` and the down-regulated gene, respectively, for each cell type. Value represents correlation in expression. The top 50 genes are shown for readability. 

The enrichment plots show enrichment in biological pathways of the top 200 up-regulated or down-regulated genes in each cell type. Top 10 pathways are shown. 


```{r}
if("feature_gene_cor_celltype" %in% names(scfeatures_result) ){
    data <- scfeatures_result$feature_gene_cor_celltype
    data <- t(data)
    
    gene_output <- plot_heatmap(data)
}
```


# Cell type specific pathway expression

## pathway gsva

The heatmaps show the up-regulated pathway in `r cond1` compared to the `r cond2` and the down-regulated gene, respectively, for each cell type. Value represents pathway scores calculated using GSVA.  

```{r}
if("feature_pathway_gsva" %in% names(scfeatures_result) ){    
    data <- scfeatures_result$feature_pathway_gsva
    data <- t(data)
    
    gene_output <- plot_heatmap(data, pathway = T)
}
```

## pathway mean  

The heatmaps show the up-regulated pathway in `r cond1` compared to the `r cond2` and the down-regulated gene, respectively, for each cell type. Value represents expression values of the genes in each pathway. 

```{r}
if("feature_pathway_mean" %in% names(scfeatures_result) ){   
    data <- scfeatures_result$feature_pathway_mean
    data <- t(data)
    
    gene_output <- plot_heatmap(data, pathway = T)
}
```

## pathway proportion

The heatmaps show the up-regulated pathway in `r cond1` compared to the `r cond2` and the down-regulated gene, respectively, for each cell type. Value represents proportion expression of genes in each pathway. 

```{r}
if("feature_pathway_prop" %in% names(scfeatures_result) ){   
    data <- scfeatures_result$feature_pathway_prop
    data <- t(data)
    
    gene_output <- plot_heatmap(data, pathway = T)
}
```


# Cell type specific cell-cell communications


```{r}

plot_CCI <- function(data){
  

    patient <- unlist( lapply( strsplit( colnames(data), "_cond_"), `[`, 1) ) 
    
    remove <- which(patient == "NA")
    if (length(remove) > 0 ){
       patient <-  patient[-c(remove)]
       data <- data[ , -c(remove)]
    }
    
    condition <- unlist( lapply( strsplit( colnames(data), "_cond_"), `[`, 2) ) 
    celltype <- unlist( lapply( strsplit( rownames(data), "--"), `[`, 1) )
    
    thiscelltype <-  unique(celltype)[1]
    
    df <- NULL
    for (thiscelltype in unique(celltype)){
       data_thiscelltype <- data[which(celltype == thiscelltype), ]
       cond1_count <- data_thiscelltype[, which( condition == unique( condition)[1])]
       cond1_count <-  sum(cond1_count != 0)/ncol(cond1_count)
       
       cond2_count <-data_thiscelltype[ , which( condition == unique( condition)[2])]
       cond2_count <- sum( cond2_count !=0 )/ncol(cond2_count)
       
       temp <- data.frame(ligand  = strsplit( thiscelltype, " -> ")[[1]][1],
                          receptor = strsplit( thiscelltype, " -> ")[[1]][2],
                          diff = cond1_count - cond2_count )
       df <- rbind(df, temp)
    }
    
    df <- as.data.frame( tidyr::pivot_wider(df, names_from = receptor, values_from = diff) )
    
    rownames(df) <- df$ligand
    df <- df[, -1]
    
   setHook("grid.newpage", function() pushViewport(viewport(x=1,y=1,width=0.9, height=0.9, name="vp", just=c("right","top"))), action="prepend")
     pheatmap(  df , fontsize_row = 10 , fontsize_col = 10,  cluster_cols = F,
                 cluster_rows = F ,
                display_numbers =T ,  number_color = "black" )
  setHook("grid.newpage", NULL, "replace")
  grid::grid.text("sender (ligand)", y=-0.07, gp=gpar(fontsize=16))
  grid::grid.text("target (receptor)", x=-0.07, rot=90, gp=gpar(fontsize=16)) 
   
    
   
   #  https://stackoverflow.com/questions/49171958/igraph-edge-width-and-color-positive-and-negative-correlation
    df_net <- round( as.matrix(df) , 2)
    g <- graph_from_adjacency_matrix(df_net, mode = "directed", weighted = T)
    E(g)$color <- ifelse(E(g)$weight > 0,'coral1','cornflowerblue')  
    E(g)$label.color<- "black"
 
    plot(g,  
         edge.curved=0.3 , edge.arrow.size=0.4, vertex.label.dist=4 ,
         edge.width=as.integer(cut(abs(E(g)$weight), breaks = 5)) ,
        edge.label = E(g)$weight,
         
         vertex.color="azure",
         vertex.label.color="black"  ,
         vertex.label.family="Helvetica", edge.label.family="Helvetica"
          
     )
    
}    
 
```



Heatmap shows the up-regulated cell cell interaction pair in `r cond1` compared to the `r cond2` and the down-regulated gene, respectively, for each cell type. Value represents cell cell interaction score.  

```{r}
if("feature_CCI" %in% names(scfeatures_result) ){  
    data <- scfeatures_result$feature_CCI
    data <- t(data)
    
    gene_output <- plot_heatmap_bulk(data )
}
```


Heatmap and and network plot indicates the difference in the number of cell-cell interaction pairs between `r cond1` and `r cond2`. Red indicates a positivie difference (ie, greater in `r cond1`) and blue indicates a negative difference (ie, greater in `r cond2`). 

```{r  fig.height=4, fig.width=4}
if("feature_CCI" %in% names(scfeatures_result) ){  
    plot_CCI(data)
}
```


# Overall aggregated gene expressions

## gene mean aggregated

The heatmaps show the up-regulated gene in `r cond1` compared to the `r cond2` and the down-regulated gene, respectively. Value represents average gene expression. The top 50 genes are shown for readability. 

The enrichment plots show enrichment in biological pathways of the top 200 up-regulated or down-regulated genes in each cell type. Top 10 pathways are shown. 

```{r}
if("feature_gene_mean_aggregated" %in% names(scfeatures_result) ){  
    data <- scfeatures_result$feature_gene_mean_aggregated
    data <- t(data)
    
    gene_output <- plot_heatmap_bulk(data)
}
```


```{r fig.height=4, fig.width=6}
if("feature_gene_mean_aggregated" %in% names(scfeatures_result) ){ 
    plot_go_bulk(gene_output)
}
```



## gene proportion aggregated

The heatmaps show the up-regulated gene in `r cond1` compared to the `r cond2` and the down-regulated gene, respectively. Value represents average proportion of expression (ie, across all cells, the percentage of cells that express a particular gene). The top 50 genes are shown for readability. 

The enrichment plots show enrichment in biological pathways of the top 200 up-regulated or down-regulated genes in each cell type. Top 10 pathways are shown. 


```{r}
if("feature_gene_prop_aggregated" %in% names(scfeatures_result) ){ 
    data <- scfeatures_result$feature_gene_prop_aggregated
    data <- t(data)
    
    gene_output <- plot_heatmap_bulk(data)
}
```

```{r fig.height=4, fig.width=6}
if("feature_gene_prop_aggregated" %in% names(scfeatures_result) ){ 
    plot_go_bulk(gene_output)
}
```



## gene correlation aggregated

The heatmaps show the up-regulated gene in `r cond1` compared to the `r cond2` and the down-regulated gene, respectively. Value represents correlation in expression. The top 50 genes are shown for readability. 

The enrichment plots show enrichment in biological pathways of the top 200 up-regulated or down-regulated genes in each cell type. Top 10 pathways are shown. 

```{r}
if("feature_gene_cor_aggregated" %in% names(scfeatures_result) ){ 
    data <- scfeatures_result$feature_gene_cor_aggregated
    data <- t(data)
    
    gene_output <- plot_heatmap_bulk(data)
}
```

# Spatial metrics

## L function

The heatmaps show the up-regulated cell type pairs in `r cond1` compared to the `r cond2` and the down-regulated cell type pairs, respectively. Value represents L score. The top 50 cell type pairs are shown for readability. 


```{r}
if("feature_L_stats" %in% names(scfeatures_result) ){ 
    data <- scfeatures_result$feature_L_stats
    data <- t(data)
    
    gene_output <- plot_heatmap_bulk(data)
}
```


## cell type interaction

The heatmaps show the up-regulated cell type pairs in `r cond1` compared to the `r cond2` and the down-regulated cell type pairs, respectively. Value represents interaction score.


```{r}
if("feature_celltype_interaction" %in% names(scfeatures_result) ){ 
    data <- scfeatures_result$feature_celltype_interaction
    data <- t(data)
    
    gene_output <- plot_heatmap_bulk(data)
}
```


## Moran's I

The heatmaps show the up-regulated genes in `r cond1` compared to the `r cond2` and the down-regulated genes, respectively. Value represents Moran's I value.



```{r}
if("feature_morans_I" %in% names(scfeatures_result) ){ 
    data <- scfeatures_result$feature_morans_I
    data <- t(data)
    
    gene_output <- plot_heatmap_bulk(data)
}
```



## nearest neighbour correlation 

The heatmaps show the up-regulated genes in `r cond1` compared to the `r cond2` and the down-regulated gene, respectively. Value represents nearest neighbour correlation score. 


```{r}
if("feature_nn_correlation" %in% names(scfeatures_result) ){ 
    data <- scfeatures_result$feature_nn_correlation
    data <- t(data)
    
    gene_output <- plot_heatmap_bulk(data)
}
```







